<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋小游戏 - 在线对战</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .status-panel {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        .player-info, .game-status {
            font-size: 1.1em;
            margin: 10px;
        }

        #current-player {
            font-weight: bold;
            color: #000;
        }

        #game-status {
            font-weight: bold;
            color: #28a745;
        }

        #reset-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px;
        }

        #reset-btn:hover {
            background-color: #0056b3;
        }

        .board-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #board {
            width: 560px;
            height: 560px;
            background-color: #d4a76a;
            border: 10px solid #8b4513;
            position: relative;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
        }

        /* 面板通用样式 */
        .panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* 房间管理面板样式 */
        #room-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .room-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #create-room-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #create-room-btn:hover {
            background-color: #218838;
        }
        
        .join-room {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #room-id-input {
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 120px;
            text-align: center;
        }
        
        #join-room-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #join-room-btn:hover {
            background-color: #0056b3;
        }
        
        .room-info {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 1.1em;
            margin-top: 15px;
        }
        
        #leave-room-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px;
        }
        
        #leave-room-btn:hover {
            background-color: #c82333;
        }
        
        .player-role {
            font-size: 1.1em;
            margin: 10px;
        }
        
        #player-role {
            font-weight: bold;
            color: #6c757d;
        }
        
        .cell {
            width: 100%;
            height: 100%;
            border-right: 1px solid #8b4513;
            border-bottom: 1px solid #8b4513;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .cell:first-child, .cell:nth-child(15n) {
            border-right: none;
        }

        .cell:nth-last-child(-n+15) {
            border-bottom: none;
        }

        /* 棋子样式 */
        .stone {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .stone.black {
            background-color: #000;
        }

        .stone.white {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        /* 棋盘上的星位点 */
        .cell::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
        }

        /* 天元和星位点 - 修正位置 */
        .cell:nth-child(113)::before, /* 天元 (8,8) */
        .cell:nth-child(50)::before, /* 左上角星位 (4,4) */
        .cell:nth-child(58)::before, /* 右上角星位 (4,12) */
        .cell:nth-child(169)::before, /* 左下角星位 (12,4) */
        .cell:nth-child(177)::before /* 右下角星位 (12,12) */
        {
            opacity: 1;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            
            .status-panel {
                flex-direction: column;
            }
            
            #board {
                width: 360px;
                height: 360px;
                border: 5px solid #8b4513;
            }
            
            .stone {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>五子棋小游戏 - 在线对战</h1>
        
        <!-- 房间管理面板 -->
        <div id="room-panel" class="panel">
            <h2>房间管理</h2>
            <div class="room-actions">
                <button id="create-room-btn">创建房间</button>
                <div class="join-room">
                    <input type="text" id="room-id-input" placeholder="房间ID" maxlength="6">
                    <button id="join-room-btn">加入房间</button>
                </div>
            </div>
            <div id="room-info" class="room-info"></div>
        </div>
        
        <!-- 游戏面板 -->
        <div id="game-panel" class="panel" style="display: none;">
            <div class="status-panel">
                <div class="player-info">
                    当前玩家：<span id="current-player">黑方</span>
                </div>
                <div class="player-role">
                    你的角色：<span id="player-role">未分配</span>
                </div>
                <div class="game-status">
                    游戏状态：<span id="game-status">等待玩家</span>
                </div>
                <button id="reset-btn">重新开始</button>
                <button id="leave-room-btn">离开房间</button>
            </div>
            
            <div class="board-container">
                <div id="board"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置（使用用户提供的配置）
        const firebaseConfig = {
            apiKey: "AIzaSyDVlgT5Zg4rNRu-FYEKnG7bmonBQ9ukkE8",
            authDomain: "html-wuziqi.firebaseapp.com",
            databaseURL: "https://html-wuziqi-default-rtdb.firebaseio.com",
            projectId: "html-wuziqi",
            storageBucket: "html-wuziqi.firebasestorage.app",
            messagingSenderId: "18511424016",
            appId: "1:18511424016:web:5197cb2ecde6abb5fb7895",
            measurementId: "G-BS7NYWJVPP"
        };
        
        // 初始化Firebase
        console.log('开始初始化Firebase');
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase初始化成功');
            database = firebase.database();
            console.log('Firebase数据库获取成功');
        } catch (error) {
            console.error('Firebase初始化失败：', error);
            roomInfo.innerHTML = `<p style="color: red;">Firebase初始化失败：${error.message}</p>`;
        }
        
        // 游戏常量
        const BOARD_SIZE = 15;
        const BLACK = 'black';
        const WHITE = 'white';
        
        // 音频上下文（用于生成音效）
        let audioContext;
        
        // 游戏状态
        let board;
        let currentPlayer;
        let gameStatus;
        
        // 在线对战状态
        let roomId = null;
        let playerRole = null;
        let gameRef = null;
        let roomRef = null;
        let isMyTurn = false;
        let database = null;
        
        // DOM元素
        const boardElement = document.getElementById('board');
        const currentPlayerElement = document.getElementById('current-player');
        const gameStatusElement = document.getElementById('game-status');
        const playerRoleElement = document.getElementById('player-role');
        const resetButton = document.getElementById('reset-btn');
        
        // 房间管理DOM元素
        const roomPanel = document.getElementById('room-panel');
        const gamePanel = document.getElementById('game-panel');
        const roomInfo = document.getElementById('room-info');
        const createRoomButton = document.getElementById('create-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const joinRoomButton = document.getElementById('join-room-btn');
        const leaveRoomButton = document.getElementById('leave-room-btn');
        
        // 初始化音频上下文
        function initAudioContext() {
            try {
                // 创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
        }
        
        // 播放落子音效
        function playPlaceSound() {
            if (!audioContext) return;
            
            // 创建振荡器
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // 连接节点
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // 设置音效参数
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            // 设置波形和播放时间
            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // 初始化游戏
        function initGame() {
            // 初始化棋盘数组
            board = [];
            for (let i = 0; i < BOARD_SIZE; i++) {
                board[i] = [];
                for (let j = 0; j < BOARD_SIZE; j++) {
                    board[i][j] = null;
                }
            }
            
            // 初始化游戏状态
            currentPlayer = BLACK;
            gameStatus = 'playing';
            
            // 更新UI
            updateUI();
            
            // 渲染棋盘
            renderBoard();
            
            // 确保音频上下文已初始化
            if (!audioContext) {
                initAudioContext();
            }
        }
        
        // 渲染棋盘
        function renderBoard() {
            // 清空棋盘
            boardElement.innerHTML = '';
            
            // 创建棋盘格子
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    // 添加点击事件
                    cell.addEventListener('click', handleCellClick);
                    
                    boardElement.appendChild(cell);
                }
            }
        }
        
        // 处理格子点击
        function handleCellClick(event) {
            if (gameStatus !== 'playing' || !isMyTurn) return;
            
            const cell = event.target;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            // 检查该位置是否已有棋子
            if (board[row][col] !== null) return;
            
            // 落子
            placeStone(row, col, currentPlayer);
            
            // 检查是否获胜
            if (checkWin(row, col)) {
                gameStatus = 'win';
                updateUI();
                
                // 更新数据库
                if (gameRef) {
                    gameRef.update({
                        board: board,
                        currentPlayer: currentPlayer,
                        gameStatus: gameStatus
                    });
                }
                return;
            }
            
            // 检查是否平局
            if (checkDraw()) {
                gameStatus = 'draw';
                updateUI();
                
                // 更新数据库
                if (gameRef) {
                    gameRef.update({
                        board: board,
                        currentPlayer: currentPlayer,
                        gameStatus: gameStatus
                    });
                }
                return;
            }
            
            // 切换玩家
            currentPlayer = currentPlayer === BLACK ? WHITE : BLACK;
            isMyTurn = false;
            updateUI();
            
            // 更新数据库
            if (gameRef) {
                gameRef.update({
                    board: board,
                    currentPlayer: currentPlayer,
                    gameStatus: gameStatus
                });
            }
        }
        
        // 落子
        function placeStone(row, col, color) {
            // 更新棋盘数据
            board[row][col] = color;
            
            // 创建棋子元素
            const stone = document.createElement('div');
            stone.className = `stone ${color}`;
            
            // 找到对应的格子并添加棋子
            const cells = document.querySelectorAll('.cell');
            const index = row * BOARD_SIZE + col;
            cells[index].appendChild(stone);
            
            // 播放落子音效
            playPlaceSound();
        }
        
        // 检查胜利条件
        function checkWin(row, col) {
            const color = board[row][col];
            
            // 检查水平方向
            let count = 1;
            // 向左检查
            for (let j = col - 1; j >= 0; j--) {
                if (board[row][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            // 向右检查
            for (let j = col + 1; j < BOARD_SIZE; j++) {
                if (board[row][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            if (count >= 5) return true;
            
            // 检查垂直方向
            count = 1;
            // 向上检查
            for (let i = row - 1; i >= 0; i--) {
                if (board[i][col] === color) {
                    count++;
                } else {
                    break;
                }
            }
            // 向下检查
            for (let i = row + 1; i < BOARD_SIZE; i++) {
                if (board[i][col] === color) {
                    count++;
                } else {
                    break;
                }
            }
            if (count >= 5) return true;
            
            // 检查对角线方向 (左上到右下)
            count = 1;
            // 左上检查
            for (let i = row - 1, j = col - 1; i >= 0 && j >= 0; i--, j--) {
                if (board[i][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            // 右下检查
            for (let i = row + 1, j = col + 1; i < BOARD_SIZE && j < BOARD_SIZE; i++, j++) {
                if (board[i][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            if (count >= 5) return true;
            
            // 检查对角线方向 (右上到左下)
            count = 1;
            // 右上检查
            for (let i = row - 1, j = col + 1; i >= 0 && j < BOARD_SIZE; i--, j++) {
                if (board[i][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            // 左下检查
            for (let i = row + 1, j = col - 1; i < BOARD_SIZE && j >= 0; i++, j--) {
                if (board[i][j] === color) {
                    count++;
                } else {
                    break;
                }
            }
            if (count >= 5) return true;
            
            return false;
        }
        
        // 检查平局
        function checkDraw() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    if (board[i][j] === null) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        // 更新UI
        function updateUI() {
            // 更新当前玩家显示
            currentPlayerElement.textContent = currentPlayer === BLACK ? '黑方' : '白方';
            // 白棋时使用深色文字以增加对比度
            currentPlayerElement.style.color = currentPlayer === BLACK ? BLACK : '#333333';
            
            // 更新玩家角色显示
            if (playerRole) {
                playerRoleElement.textContent = playerRole === BLACK ? '黑方' : '白方';
                playerRoleElement.style.color = playerRole === BLACK ? BLACK : '#333333';
            }
            
            // 更新游戏状态显示
            if (gameStatus === 'playing') {
                gameStatusElement.textContent = isMyTurn ? '你的回合' : '等待对方';
                gameStatusElement.style.color = isMyTurn ? '#28a745' : '#6c757d';
            } else if (gameStatus === 'win') {
                const winner = currentPlayer === BLACK ? '黑方' : '白方';
                const isPlayerWinner = playerRole === currentPlayer;
                gameStatusElement.textContent = isPlayerWinner ? '你赢了！' : `${winner}获胜！`;
                gameStatusElement.style.color = isPlayerWinner ? '#28a745' : '#dc3545';
            } else if (gameStatus === 'draw') {
                gameStatusElement.textContent = '平局';
                gameStatusElement.style.color = '#ffc107';
            } else if (gameStatus === 'waiting') {
                gameStatusElement.textContent = '等待玩家加入';
                gameStatusElement.style.color = '#6c757d';
            }
        }
        
        // 创建房间
        function createRoom() {
            console.log('创建房间按钮被点击');
            
            // 检查database是否初始化
            if (!database) {
                console.error('Firebase数据库未初始化');
                roomInfo.innerHTML = '<p style="color: red;">Firebase数据库未初始化，请刷新页面重试</p>';
                return;
            }
            
            // 生成6位随机房间ID
            roomId = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('生成的房间ID：', roomId);
            
            try {
                // 初始化游戏数据
                const initialGameData = {
                    board: Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(null)),
                    currentPlayer: BLACK,
                    gameStatus: 'waiting',
                    players: {
                        black: 'player1',
                        white: null
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // 创建房间
                roomRef = database.ref(`rooms/${roomId}`);
                gameRef = roomRef.child('game');
                console.log('房间引用创建成功');
                
                // 设置初始游戏数据
                gameRef.set(initialGameData).then(() => {
                    console.log('房间创建成功');
                    // 设置当前玩家为黑方
                    playerRole = BLACK;
                    isMyTurn = false;
                    
                    // 更新界面
                    roomInfo.innerHTML = `<p>房间创建成功！</p><p>房间ID：<strong>${roomId}</strong></p><p>等待玩家加入...</p>`;
                    
                    // 监听房间变化
                    setupRoomListeners();
                }).catch(error => {
                    console.error('创建房间失败：', error);
                    roomInfo.innerHTML = `<p style="color: red;">创建房间失败：${error.message}</p>`;
                });
            } catch (error) {
                console.error('创建房间过程中发生异常：', error);
                roomInfo.innerHTML = `<p style="color: red;">创建房间失败：${error.message}</p>`;
            }
        }
        
        // 加入房间
        function joinRoom() {
            roomId = roomIdInput.value.trim();
            
            if (!roomId) {
                roomInfo.innerHTML = '<p style="color: red;">请输入房间ID</p>';
                return;
            }
            
            // 检查房间是否存在
            roomRef = database.ref(`rooms/${roomId}`);
            gameRef = roomRef.child('game');
            
            roomRef.once('value', (snapshot) => {
                const roomData = snapshot.val();
                
                if (!roomData) {
                    roomInfo.innerHTML = '<p style="color: red;">房间不存在</p>';
                    return;
                }
                
                // 检查房间是否已满
                if (roomData.game.players.white) {
                    roomInfo.innerHTML = '<p style="color: red;">房间已满</p>';
                    return;
                }
                
                // 设置当前玩家为白方
                playerRole = WHITE;
                isMyTurn = false;
                
                // 更新房间信息
                roomRef.child('game/players/white').set('player2');
                roomRef.child('game/gameStatus').set('playing');
                
                // 初始化游戏
                initGame();
                
                // 更新界面
                roomPanel.style.display = 'none';
                gamePanel.style.display = 'block';
                
                // 监听房间变化
                setupRoomListeners();
            }).catch(error => {
                console.error('加入房间失败：', error);
                roomInfo.innerHTML = `<p style="color: red;">加入房间失败：${error.message}</p>`;
            });
        }
        
        // 设置房间监听器
        function setupRoomListeners() {
            if (!gameRef) return;
            
            // 监听游戏数据变化
            gameRef.on('value', (snapshot) => {
                const gameData = snapshot.val();
                
                if (!gameData) return;
                
                // 更新游戏状态
                board = gameData.board || Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(null));
                currentPlayer = gameData.currentPlayer || BLACK;
                gameStatus = gameData.gameStatus || 'playing';
                
                // 更新玩家回合
                isMyTurn = playerRole === currentPlayer;
                
                // 更新棋盘显示
                renderBoardFromData(board);
                
                // 更新UI
                updateUI();
                
                // 如果是等待状态且玩家已满，开始游戏
                if (gameData.players && gameData.players.black && gameData.players.white && gameStatus === 'waiting') {
                    gameStatus = 'playing';
                    
                    // 切换到游戏面板
                    roomPanel.style.display = 'none';
                    gamePanel.style.display = 'block';
                    
                    // 黑方先走
                    if (playerRole === BLACK) {
                        isMyTurn = true;
                    }
                    
                    // 更新UI
                    updateUI();
                }
            });
        }
        
        // 根据数据渲染棋盘
        function renderBoardFromData(boardData) {
            // 重新渲染棋盘
            renderBoard();
            
            // 重新放置所有棋子
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const color = boardData[row][col];
                    if (color) {
                        placeStone(row, col, color);
                    }
                }
            }
        }
        
        // 离开房间
        function leaveRoom() {
            if (!roomRef) return;
            
            // 移除监听器
            gameRef.off();
            roomRef.off();
            
            // 清空房间信息
            roomId = null;
            playerRole = null;
            gameRef = null;
            roomRef = null;
            isMyTurn = false;
            
            // 重置游戏
            initGame();
            
            // 更新界面
            gamePanel.style.display = 'none';
            roomPanel.style.display = 'block';
            roomInfo.innerHTML = '';
            roomIdInput.value = '';
        }
        
        // 重新开始游戏
        function resetGame() {
            if (gameRef) {
                // 在线重置
                const initialGameData = {
                    board: Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(null)),
                    currentPlayer: BLACK,
                    gameStatus: 'playing'
                };
                
                gameRef.update(initialGameData);
            } else {
                // 本地重置
                initGame();
            }
        }
        
        // 绑定事件
        resetButton.addEventListener('click', resetGame);
        createRoomButton.addEventListener('click', createRoom);
        joinRoomButton.addEventListener('click', joinRoom);
        leaveRoomButton.addEventListener('click', leaveRoom);
        
        // 回车加入房间
        roomIdInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                joinRoom();
            }
        });
        
        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>